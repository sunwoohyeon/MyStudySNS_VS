# 시스템 전체 흐름도

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   사용자 (Browser)                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          │ HTTP/HTTPS
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Next.js 15 Application                                 │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                           클라이언트 (React 18)                               │  │
│  │                                                                              │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────────┐    │  │
│  │  │   Pages    │  │ Components │  │  Contexts  │  │       Hooks        │    │  │
│  │  │            │  │            │  │            │  │                    │    │  │
│  │  │ - page.tsx │  │ - Timeline │  │ - AuthCtx  │  │ - useAuth()        │    │  │
│  │  │ - mypage   │  │ - PostForm │  │            │  │ - useState/Effect  │    │  │
│  │  │ - post/[id]│  │ - StudyNote│  │            │  │                    │    │  │
│  │  │ - write    │  │ - Schedule │  │            │  │                    │    │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
│                                          │                                          │
│                                          │ Internal API Calls                       │
│                                          ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────────────┐  │
│  │                            서버 (API Routes)                                  │  │
│  │                                                                              │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐  │  │
│  │  │   /api/posts     │  │ /api/notes/      │  │  /api/knowledge/         │  │  │
│  │  │   - GET (목록)   │  │    analyze       │  │     generate             │  │  │
│  │  │   - POST (생성)  │  │   - POST (분석)  │  │   - POST (생성)          │  │  │
│  │  │                  │  │                  │  │                          │  │  │
│  │  │   /api/posts/[id]│  │ /api/schedule/   │  │  /api/knowledge/[id]     │  │  │
│  │  │   - PATCH (수정) │  │    analyze       │  │   - DELETE (삭제)        │  │  │
│  │  │   - DELETE (삭제)│  │   - POST (분석)  │  │                          │  │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────────┘  │  │
│  │                                                                              │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐  │  │
│  │  │   /api/mypage    │  │  /api/comments   │  │  /api/auth/callback      │  │  │
│  │  │   - GET (조회)   │  │   - GET (목록)   │  │   - GET (OAuth)          │  │  │
│  │  │   - PUT (수정)   │  │   - POST (작성)  │  │                          │  │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                    │                           │                        │
                    │                           │                        │
                    ▼                           ▼                        ▼
    ┌───────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐
    │    Supabase Auth      │    │    Google Gemini    │    │   Supabase DB       │
    │                       │    │        API          │    │                     │
    │  - Email/Password     │    │                     │    │  - PostgreSQL       │
    │  - Google OAuth       │    │  - Gemini 2.5 Pro   │    │  - profiles         │
    │  - GitHub OAuth       │    │  - Gemini 2.5 Flash │    │  - posts            │
    │  - Kakao OAuth        │    │                     │    │  - knowledge_cards  │
    │                       │    │  기능:              │    │  - hashtags         │
    │  기능:                │    │  - 이미지 OCR       │    │  - comments         │
    │  - 세션 관리          │    │  - 텍스트 교정      │    │  - schedules        │
    │  - JWT 토큰           │    │  - 지식카드 생성    │    │                     │
    │  - 사용자 정보        │    │  - 시간표 분석      │    │  + Supabase Storage │
    │                       │    │                     │    │    (이미지 저장)    │
    └───────────────────────┘    └─────────────────────┘    └─────────────────────┘
```

---

## 2. 데이터 흐름 개요

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               데이터 흐름 다이어그램                                 │
└─────────────────────────────────────────────────────────────────────────────────────┘

     ┌─────────────┐
     │   사용자    │
     └──────┬──────┘
            │
    ┌───────┴───────┬───────────────┬───────────────┬───────────────┐
    │               │               │               │               │
    ▼               ▼               ▼               ▼               ▼
┌───────┐     ┌───────┐       ┌───────┐       ┌───────┐       ┌───────┐
│로그인 │     │게시글 │       │AI노트 │       │시간표 │       │지식   │
│       │     │작성   │       │분석   │       │분석   │       │카드   │
└───┬───┘     └───┬───┘       └───┬───┘       └───┬───┘       └───┬───┘
    │             │               │               │               │
    ▼             ▼               ▼               ▼               ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Next.js API Routes                             │
│                                                                         │
│  /auth/callback    /posts    /notes/analyze  /schedule/analyze /knowledge│
│                                                                         │
└───────┬─────────────┬─────────────┬─────────────┬─────────────┬────────┘
        │             │             │             │             │
        ▼             │             ▼             ▼             │
 ┌──────────────┐     │      ┌──────────────┐                   │
 │Supabase Auth │     │      │ Gemini API   │                   │
 │              │     │      │              │                   │
 │ 인증/세션    │     │      │ AI 분석      │                   │
 └──────────────┘     │      └──────────────┘                   │
                      │                                         │
                      ▼                                         ▼
              ┌───────────────────────────────────────────────────────┐
              │                    Supabase Database                   │
              │                                                       │
              │  profiles ◄──────► posts ◄──────► knowledge_cards    │
              │                      │                                │
              │                      ▼                                │
              │             post_hashtags ◄──────► hashtags          │
              │                      │                                │
              │                      ▼                                │
              │                  comments                             │
              └───────────────────────────────────────────────────────┘
```

---

## 3. 주요 기능별 흐름 요약

### 3.1 인증 흐름

```
사용자 ──▶ 로그인 페이지 ──▶ Supabase Auth ──▶ 세션 생성 ──▶ 홈 페이지
                │                                    │
                ├── 이메일/비밀번호                   │
                ├── Google OAuth ─────────────────────┤
                ├── GitHub OAuth ─────────────────────┤
                └── Kakao OAuth ──────────────────────┘
```

### 3.2 게시글 작성 흐름

```
사용자 ──▶ 작성 페이지 ──▶ 내용 입력 ──▶ POST /api/posts ──▶ DB 저장
                                              │
                                              ├── posts 테이블 INSERT
                                              ├── hashtags 테이블 UPSERT
                                              └── post_hashtags 연결
```

### 3.3 AI 노트 분석 흐름

```
사용자 ──▶ 이미지 업로드 ──▶ POST /api/notes/analyze
                                      │
                                      ▼
                              ┌───────────────┐
                              │  Phase 1 OCR  │
                              │  (Gemini Pro) │
                              └───────┬───────┘
                                      │
                              신뢰도 체크
                                      │
                    ┌─────────────────┴─────────────────┐
                    │                                   │
              신뢰도 ≥ 0.9                        신뢰도 < 0.9
                    │                                   │
                    ▼                                   ▼
              결과 반환                         ┌───────────────┐
                                               │  Phase 2 교정  │
                                               │  (Gemini Pro) │
                                               └───────┬───────┘
                                                       │
                                                       ▼
                                                 결과 반환
```

### 3.4 시간표 분석 흐름

```
사용자 ──▶ 시간표 이미지 ──▶ POST /api/schedule/analyze
                                      │
                                      ▼
                              ┌───────────────┐
                              │ Gemini Pro    │
                              │ 이미지 분석   │
                              └───────┬───────┘
                                      │
                                      ▼
                              형식 자동 감지
                              (24시간/12시간/교시)
                                      │
                                      ▼
                              시간 정규화 (24시간제)
                                      │
                                      ▼
                              수업 정보 배열 반환
```

### 3.5 지식카드 생성 흐름

```
사용자 ──▶ 게시글 선택 ──▶ POST /api/knowledge/generate
                                      │
                                      ▼
                              게시글 내용 조회
                                      │
                                      ▼
                              ┌───────────────┐
                              │ Gemini Flash  │
                              │ 분석 및 요약  │
                              └───────┬───────┘
                                      │
                                      ▼
                              knowledge_cards 저장
                                      │
                                      ▼
                              카드 정보 반환
```

---

## 4. 상태 관리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              상태 관리 다이어그램                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

                            ┌─────────────────────────┐
                            │      AuthContext        │
                            │                         │
                            │  - user: User | null    │
                            │  - isLoggedIn: boolean  │
                            │  - theme: 'light'|'dark'│
                            │  - logout()             │
                            │  - toggleTheme()        │
                            └───────────┬─────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
                    ▼                   ▼                   ▼
            ┌───────────────┐   ┌───────────────┐   ┌───────────────┐
            │    Header     │   │   Timeline    │   │   PostForm    │
            │               │   │               │   │               │
            │ useAuth()     │   │ useAuth()     │   │ useAuth()     │
            │ - 로그아웃    │   │ - 사용자 정보 │   │ - 사용자 ID   │
            │ - 테마 변경   │   │               │   │               │
            └───────────────┘   └───────────────┘   └───────────────┘
                                        │
                                        │
                            ┌───────────┴───────────┐
                            │   컴포넌트 로컬 상태   │
                            │                       │
                            │ - posts: Post[]       │
                            │ - sortBy: 'latest'    │
                            │ - selectedTopic       │
                            │ - currentPage         │
                            └───────────────────────┘
```

---

## 5. 에러 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               에러 처리 흐름                                        │
└─────────────────────────────────────────────────────────────────────────────────────┘

        사용자 요청
             │
             ▼
    ┌────────────────┐
    │  입력 검증     │
    │                │
    │  - 파일 형식   │
    │  - 파일 크기   │
    │  - 필수 필드   │
    └────────┬───────┘
             │
      ┌──────┴──────┐
      │             │
    검증 실패     검증 성공
      │             │
      ▼             ▼
 에러 메시지    ┌─────────────┐
 표시          │  API 요청    │
               └──────┬──────┘
                      │
               ┌──────┴──────┐
               │             │
            실패           성공
               │             │
               ▼             ▼
      ┌────────────────┐  결과 표시
      │  에러 분류     │
      │                │
      │  - 인증 오류   │ → 로그인 페이지로 리다이렉트
      │  - 네트워크    │ → "연결 실패" 메시지 + 재시도
      │  - 서버 오류   │ → "서버 오류" 메시지
      │  - AI 분석     │ → "분석 실패" 메시지
      └────────────────┘
```

---

## 6. 배포 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                               배포 아키텍처                                         │
└─────────────────────────────────────────────────────────────────────────────────────┘

     개발자
        │
        │ git push
        ▼
┌───────────────┐
│    GitHub     │
│  Repository   │
└───────┬───────┘
        │
        │ Webhook trigger
        ▼
┌───────────────┐
│ GitHub Actions│
│               │
│  - Build      │
│  - Test       │
│  - Deploy     │
└───────┬───────┘
        │
        │ SSH Deploy
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                              AWS EC2                                      │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                      Next.js Application                            │ │
│  │                                                                     │ │
│  │  npm run build → npm run start                                     │ │
│  │                                                                     │ │
│  │  Port: 3000                                                        │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                         Nginx (Reverse Proxy)                       │ │
│  │                                                                     │ │
│  │  80/443 → localhost:3000                                           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ HTTPS
        ▼
┌───────────────┐
│   사용자      │
│   (Browser)   │
└───────────────┘
```

---

## 7. 보안 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                보안 흐름                                            │
└─────────────────────────────────────────────────────────────────────────────────────┘

        사용자 요청
             │
             ▼
    ┌────────────────┐
    │  HTTPS 암호화  │
    └────────┬───────┘
             │
             ▼
    ┌────────────────┐
    │  쿠키에서      │
    │  세션 토큰     │
    │  추출          │
    └────────┬───────┘
             │
             ▼
    ┌────────────────┐
    │  Supabase      │
    │  Auth 검증     │
    │                │
    │  getUser()     │
    └────────┬───────┘
             │
      ┌──────┴──────┐
      │             │
   미인증        인증됨
      │             │
      ▼             ▼
   401 반환   ┌────────────────┐
              │  RLS 정책      │
              │  적용          │
              │                │
              │  - SELECT: 공개│
              │  - INSERT: 본인│
              │  - UPDATE: 본인│
              │  - DELETE: 본인│
              └────────┬───────┘
                       │
                       ▼
                  데이터 반환
```

---

이 문서는 My Study SNS의 전체 시스템 흐름을 설명합니다. 각 기능별 상세 흐름도는 다음 문서들에서 확인할 수 있습니다:

- [01-auth-flow.md](./01-auth-flow.md) - 인증 흐름
- [02-post-creation-flow.md](./02-post-creation-flow.md) - 게시글 작성 흐름
- [03-ai-note-analysis-flow.md](./03-ai-note-analysis-flow.md) - AI 노트 분석 흐름
- [04-schedule-analysis-flow.md](./04-schedule-analysis-flow.md) - 시간표 분석 흐름
- [05-knowledge-card-flow.md](./05-knowledge-card-flow.md) - 지식카드 생성 흐름
- [06-timeline-flow.md](./06-timeline-flow.md) - 타임라인 조회 흐름
