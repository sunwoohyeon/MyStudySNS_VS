# AI 노트 분석 흐름도

## 1. 기능 개요

AI 노트 분석은 손글씨 또는 인쇄된 노트 이미지를 마크다운 형식의 디지털 문서로 변환하는 핵심 기능입니다.

### 주요 특징

- **2단계 분석 시스템**: OCR 추출 + AI 교정
- **다중 이미지 지원**: 최대 10장까지 동시 분석
- **LaTeX 수식 변환**: 수학/과학 노트 지원
- **신뢰도 기반 최적화**: 높은 신뢰도면 교정 스킵

---

## 2. 전체 흐름도

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           AI 노트 분석 전체 흐름                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

     사용자
        │
        │ 1. 노트 이미지 선택
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    StudyNoteUploadForm.tsx                                │
│                                                                           │
│  Step 1: 업로드                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │     📤 이미지 드래그 앤 드롭 또는 클릭                              │ │
│  │                                                                     │ │
│  │     지원: JPG, PNG, WebP, GIF (최대 10MB, 10장)                    │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 2. 이미지 검증
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        이미지 검증 로직                                    │
│                                                                           │
│  const validateImage = (file: File) => {                                 │
│    // 파일 형식 검증                                                      │
│    if (!['image/jpeg', 'image/png', 'image/webp', 'image/gif']           │
│        .includes(file.type)) {                                            │
│      return "지원하지 않는 형식입니다.";                                  │
│    }                                                                      │
│                                                                           │
│    // 파일 크기 검증 (10MB)                                               │
│    if (file.size > 10 * 1024 * 1024) {                                   │
│      return "10MB 이하만 가능합니다.";                                   │
│    }                                                                      │
│                                                                           │
│    // 이미지 개수 검증                                                    │
│    if (images.length >= 10) {                                            │
│      return "최대 10장까지 가능합니다.";                                 │
│    }                                                                      │
│                                                                           │
│    return null;  // 검증 통과                                            │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 3. 분석 시작 버튼 클릭
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    Step 2: 분석 중 (Analyzing)                            │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │  이미지 1  [████████████████] 100%  ✓ 완료                         │ │
│  │  이미지 2  [████████░░░░░░░░]  50%  Phase 1 분석 중...             │ │
│  │  이미지 3  [░░░░░░░░░░░░░░░░]   0%  대기 중                        │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  // 순차적 분석 (for loop)                                               │
│  for (const image of images) {                                           │
│    await analyzeImage(image);                                            │
│  }                                                                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 4. 각 이미지별 API 호출
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    POST /api/notes/analyze                                │
│                                                                           │
│  요청 본문:                                                               │
│  {                                                                        │
│    "image": "base64_encoded_data...",                                    │
│    "mimeType": "image/jpeg"                                              │
│  }                                                                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │
        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              2단계 AI 분석 시스템                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘
        │
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    Phase 1: OCR 추출 (Gemini 2.5 Pro)                     │
│                                                                           │
│  const model = genAI.getGenerativeModel({                                │
│    model: "gemini-2.5-pro-preview-05-06"                                 │
│  });                                                                      │
│                                                                           │
│  const systemPrompt = `                                                  │
│  당신은 학습 노트를 분석하는 AI입니다.                                   │
│  이미지의 텍스트를 정확하게 추출하여 마크다운으로 변환하세요.            │
│                                                                           │
│  규칙:                                                                    │
│  - 수식은 LaTeX 형식 ($...$, $$...$$)                                    │
│  - 손글씨 vs 인쇄물 판별                                                 │
│  - 그림은 [그림: 설명] 형식                                              │
│  - 적절한 마크다운 구조화 (헤더, 목록, 강조)                             │
│                                                                           │
│  출력 JSON:                                                               │
│  {                                                                        │
│    "title": "제목 (15자 이내)",                                          │
│    "content": "마크다운 본문",                                           │
│    "summary": "2-3줄 요약",                                              │
│    "hashtags": ["키워드1", ...],                                         │
│    "subject": "과목명",                                                   │
│    "confidence": 0.85  // 0.0 ~ 1.0                                      │
│  }                                                                        │
│  `;                                                                       │
│                                                                           │
│  const result = await model.generateContent([                            │
│    { inlineData: { mimeType, data: base64Image } },                      │
│    { text: systemPrompt }                                                 │
│  ]);                                                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ Phase 1 결과
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        신뢰도 체크                                        │
│                                                                           │
│  if (initialResult.confidence >= 0.9) {                                  │
│    // 높은 신뢰도: Phase 2 스킵                                          │
│    return {                                                               │
│      ...initialResult,                                                    │
│      refinement: { applied: false }                                       │
│    };                                                                     │
│  }                                                                        │
│                                                                           │
│  // 낮은 신뢰도: Phase 2 진행                                            │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 신뢰도 < 0.9
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    Phase 2: AI 교정 (Gemini 2.5 Pro)                      │
│                                                                           │
│  const refinementPrompt = `                                              │
│  다음 OCR 결과를 검토하고 오류를 수정해주세요:                           │
│                                                                           │
│  원본 텍스트:                                                             │
│  ${initialResult.content}                                                 │
│                                                                           │
│  교정 사항:                                                               │
│  - OCR 오타 수정 (예: "돌턴" → "돌턴의")                                 │
│  - 전문 용어 정확성 검증                                                 │
│  - 문맥 보완 (끊긴 문장 연결)                                            │
│  - 과학적/학술적 사실 오류 수정                                          │
│                                                                           │
│  출력 JSON:                                                               │
│  {                                                                        │
│    "content": "교정된 마크다운",                                         │
│    "corrections": [                                                       │
│      {                                                                    │
│        "original": "원본",                                                │
│        "corrected": "수정",                                               │
│        "reason": "수정 이유"                                              │
│      }                                                                    │
│    ],                                                                     │
│    "confidence": 0.95                                                    │
│  }                                                                        │
│  `;                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ Phase 2 결과
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        결과 반환                                          │
│                                                                           │
│  return {                                                                 │
│    title: initialResult.title,                                           │
│    content: refinedResult.content,  // 교정된 내용                       │
│    summary: initialResult.summary,                                        │
│    hashtags: initialResult.hashtags,                                     │
│    subject: initialResult.subject,                                        │
│    confidence: refinedResult.confidence,                                 │
│    refinement: {                                                          │
│      applied: true,                                                       │
│      corrections: refinedResult.corrections,                             │
│      originalConfidence: initialResult.confidence,                       │
│      refinedConfidence: refinedResult.confidence                         │
│    }                                                                      │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 5. 모든 이미지 분석 완료
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    다중 이미지 결과 통합                                   │
│                                                                           │
│  const mergeResults = (results: AnalysisResult[]) => {                   │
│    // 제목: 첫 번째 이미지의 제목 사용                                   │
│    const title = results[0].title;                                       │
│                                                                           │
│    // 내용: 페이지별 구분                                                 │
│    const content = results.map((r, i) =>                                 │
│      `## 📄 페이지 ${i + 1}\n\n${r.content}`                             │
│    ).join('\n\n---\n\n');                                                 │
│                                                                           │
│    // 해시태그: 합집합 (중복 제거, 최대 10개)                            │
│    const hashtags = [...new Set(                                         │
│      results.flatMap(r => r.hashtags)                                    │
│    )].slice(0, 10);                                                       │
│                                                                           │
│    // 교정 정보: 통합                                                     │
│    const corrections = results.flatMap(r =>                              │
│      r.refinement?.corrections || []                                     │
│    ).slice(0, 15);                                                        │
│                                                                           │
│    // 신뢰도: 평균                                                        │
│    const avgConfidence = results.reduce(                                 │
│      (sum, r) => sum + r.confidence, 0                                   │
│    ) / results.length;                                                    │
│                                                                           │
│    return { title, content, hashtags, corrections, avgConfidence };      │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 6. 미리보기 단계
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    Step 3: 미리보기 (Preview)                             │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │  📝 AI 교정 내역 (3건)                                [접기 ▲]     │ │
│  │  ├─ "H20" → "H₂O" (화학식 교정)                                    │ │
│  │  ├─ "돌턴" → "돌턴의 원자론" (문맥 보완)                           │ │
│  │  └─ "톰" → "톰슨" (인명 교정)                                      │ │
│  │  📊 평균 신뢰도: 0.92                                              │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  제목: [화학 기초 - 원자의 구조________________]                         │
│                                                                           │
│  해시태그: [화학] [원자] [돌턴] [+추가]                                  │
│                                                                           │
│  내용:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │ ## 📄 페이지 1                                                      │ │
│  │                                                                     │ │
│  │ ### 돌턴의 원자론                                                   │ │
│  │ - 모든 물질은 원자로 구성                                          │ │
│  │ - 수식: $E = mc^2$                                                  │ │
│  │                                                                     │ │
│  │ ---                                                                 │ │
│  │                                                                     │ │
│  │ ## 📄 페이지 2                                                      │ │
│  │ ...                                                                 │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  [마크다운 미리보기 토글] ☑ 원본 이미지 포함                            │
│                                                                           │
│  게시판: [스터디 노트 ▼]                                                │
│                                                                           │
│  [← 다시 분석]                                     [게시하기 →]         │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 7. 게시하기 클릭
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    게시글 저장 (handleSave)                               │
│                                                                           │
│  // 원본 이미지 업로드 (옵션 선택 시)                                    │
│  if (includeOriginalImage) {                                             │
│    for (const img of images) {                                           │
│      const fileName = `${user.id}/${Date.now()}-${img.id}.${ext}`;      │
│                                                                           │
│      await supabase.storage                                              │
│        .from('post-images')                                              │
│        .upload(fileName, img.file);                                      │
│                                                                           │
│      const { publicUrl } = supabase.storage                              │
│        .from('post-images')                                              │
│        .getPublicUrl(fileName);                                          │
│                                                                           │
│      // 마크다운에 이미지 추가                                           │
│      finalContent += `\n\n![원본 노트](${publicUrl})`;                   │
│    }                                                                      │
│  }                                                                        │
│                                                                           │
│  // 게시글 저장                                                           │
│  const response = await fetch('/api/posts', {                            │
│    method: 'POST',                                                        │
│    body: JSON.stringify({                                                 │
│      title: editedTitle,                                                  │
│      content: finalContent,                                               │
│      board: selectedBoard,                                                │
│      tag: getTagFromBoard(selectedBoard),                                │
│      hashtags: editedHashtags                                             │
│    })                                                                     │
│  });                                                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 8. 저장 완료
        ▼
     게시글 페이지로 이동
```

---

## 3. 상태 관리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          컴포넌트 상태 관리                                          │
└─────────────────────────────────────────────────────────────────────────────────────┘

interface ImageItem {
  id: string;
  file: File;
  preview: string;           // Base64 미리보기
  status: 'pending' | 'analyzing' | 'done' | 'error';
  result?: AnalysisResult;   // 분석 결과
  error?: string;            // 에러 메시지
}

type Step = 'upload' | 'analyzing' | 'preview' | 'saving';

상태 흐름:

upload (이미지 업로드)
    │
    │ [분석 시작] 클릭
    ▼
analyzing (분석 중)
    │
    │ 각 이미지 상태 변화:
    │ pending → analyzing → done/error
    │
    │ 모든 이미지 분석 완료
    ▼
preview (미리보기)
    │
    │ [게시하기] 클릭
    ▼
saving (저장 중)
    │
    │ 저장 완료
    ▼
게시글 페이지로 이동
```

---

## 4. 에러 처리 흐름

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          에러 처리                                        │
│                                                                           │
│  try {                                                                    │
│    const response = await fetch('/api/notes/analyze', { ... });          │
│                                                                           │
│    if (!response.ok) {                                                   │
│      throw new Error(`HTTP ${response.status}`);                         │
│    }                                                                      │
│                                                                           │
│    const data = await response.json();                                   │
│                                                                           │
│    if (!data.success) {                                                  │
│      throw new Error(data.error || '분석 실패');                         │
│    }                                                                      │
│                                                                           │
│    // 성공: 상태 업데이트                                                │
│    setImages(prev => prev.map(img =>                                     │
│      img.id === currentId                                                 │
│        ? { ...img, status: 'done', result: data.data }                   │
│        : img                                                              │
│    ));                                                                    │
│                                                                           │
│  } catch (error) {                                                       │
│    // 실패: 에러 상태 업데이트                                           │
│    setImages(prev => prev.map(img =>                                     │
│      img.id === currentId                                                 │
│        ? { ...img, status: 'error', error: error.message }               │
│        : img                                                              │
│    ));                                                                    │
│  }                                                                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘

에러 종류:
├── 파일 형식 오류: "지원하지 않는 이미지 형식입니다."
├── 파일 크기 오류: "이미지 크기는 10MB 이하여야 합니다."
├── 네트워크 오류: "네트워크 연결을 확인해주세요."
├── AI 분석 오류: "이미지 분석에 실패했습니다."
└── 저장 오류: "게시글 저장에 실패했습니다."
```

---

## 5. 관련 파일

| 파일 | 역할 |
|------|------|
| `src/component/StudyNoteUploadForm.tsx` | 메인 UI 컴포넌트 |
| `src/app/api/notes/analyze/route.ts` | AI 분석 API |
| `src/app/api/posts/route.ts` | 게시글 저장 API |

---

## 6. 성능 최적화

| 최적화 | 설명 |
|--------|------|
| 신뢰도 기반 스킵 | 신뢰도 ≥ 0.9면 Phase 2 스킵 |
| 순차 처리 | 메모리 효율을 위해 순차 분석 |
| Base64 인코딩 | 멀티파트 대신 JSON 사용 |
