# 인증 흐름도

## 1. 인증 시스템 개요

My Study SNS는 Supabase Auth를 사용하여 다양한 인증 방식을 지원합니다.

### 지원 인증 방식

| 방식 | Provider | 설명 |
|------|----------|------|
| 이메일/비밀번호 | Supabase | 기본 인증 방식 |
| Google | OAuth 2.0 | 소셜 로그인 |
| GitHub | OAuth | 소셜 로그인 |
| Kakao | OAuth | 소셜 로그인 |

---

## 2. 이메일 로그인 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            이메일 로그인 흐름                                        │
└─────────────────────────────────────────────────────────────────────────────────────┘

     사용자
        │
        │ 1. 로그인 페이지 접속
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         /login 페이지                                      │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │     이메일: [________________________]                              │ │
│  │                                                                     │ │
│  │     비밀번호: [________________________]                            │ │
│  │                                                                     │ │
│  │     [          로그인          ]                                    │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 2. 로그인 버튼 클릭
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      클라이언트 처리                                       │
│                                                                           │
│  const { error } = await supabase.auth.signInWithPassword({              │
│    email: email,                                                          │
│    password: password,                                                    │
│  });                                                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 3. Supabase Auth 요청
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        Supabase Auth                                      │
│                                                                           │
│  - 이메일/비밀번호 검증                                                   │
│  - 사용자 정보 조회                                                       │
│  - JWT 토큰 생성                                                          │
│  - 세션 정보 반환                                                         │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 4. 응답 처리
        ▼
┌───────────────────────────┐              ┌───────────────────────────┐
│      로그인 성공          │              │      로그인 실패          │
│                           │              │                           │
│  - 세션 쿠키 저장         │              │  - 에러 메시지 표시       │
│  - AuthContext 업데이트   │              │  - "이메일/비밀번호 확인" │
│                           │              │                           │
└─────────────┬─────────────┘              └───────────────────────────┘
              │
              │ 5. 프로필 상태 확인
              ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      프로필 완성 여부 확인                                 │
│                                                                           │
│  const { data: profile } = await supabase                                │
│    .from("profiles")                                                      │
│    .select("major")                                                       │
│    .eq("id", user.id)                                                     │
│    .single();                                                             │
│                                                                           │
│  if (!profile || profile.major === "전공 미입력") {                       │
│    router.push("/signup");  // 프로필 설정 페이지로                       │
│  } else {                                                                 │
│    router.push("/");        // 홈 페이지로                                │
│  }                                                                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 소셜 로그인 흐름 (OAuth)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            소셜 로그인 흐름 (OAuth)                                  │
└─────────────────────────────────────────────────────────────────────────────────────┘

     사용자
        │
        │ 1. 소셜 로그인 버튼 클릭
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    SocialLoginSection.tsx                                  │
│                                                                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │
│  │   Google     │  │    GitHub    │  │    Kakao     │                   │
│  │   로그인     │  │    로그인    │  │    로그인    │                   │
│  └──────────────┘  └──────────────┘  └──────────────┘                   │
│                                                                           │
│  const { error } = await supabase.auth.signInWithOAuth({                 │
│    provider: 'google',  // 또는 'github', 'kakao'                        │
│    options: {                                                             │
│      redirectTo: `${origin}/auth/callback`,                              │
│    },                                                                     │
│  });                                                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 2. OAuth Provider로 리다이렉트
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      OAuth Provider (Google/GitHub/Kakao)                 │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │     "My Study SNS"가 다음 정보에 접근하려 합니다:                   │ │
│  │                                                                     │ │
│  │     - 이메일 주소                                                   │ │
│  │     - 프로필 정보                                                   │ │
│  │                                                                     │ │
│  │     [  허용  ]     [  거부  ]                                       │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 3. 인증 코드와 함께 콜백 URL로 리다이렉트
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                    /auth/callback/route.ts                                │
│                                                                           │
│  export async function GET(request: Request) {                           │
│    const { searchParams } = new URL(request.url);                        │
│    const code = searchParams.get("code");                                │
│                                                                           │
│    if (code) {                                                           │
│      const supabase = createRouteHandlerClient({ cookies });             │
│      await supabase.auth.exchangeCodeForSession(code);                   │
│    }                                                                      │
│                                                                           │
│    return NextResponse.redirect(new URL("/", request.url));              │
│  }                                                                        │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 4. 세션 생성 및 홈으로 리다이렉트
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                          홈 페이지 (/)                                    │
│                                                                           │
│  AuthContext에서 세션 상태 감지                                           │
│                                                                           │
│  supabase.auth.onAuthStateChange((event, session) => {                   │
│    setUser(session?.user ?? null);                                        │
│  });                                                                      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 회원가입 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              회원가입 흐름                                           │
└─────────────────────────────────────────────────────────────────────────────────────┘

     사용자
        │
        │ 1. 회원가입 페이지 접속
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         /join 페이지                                       │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │     이메일: [________________________]                              │ │
│  │                                                                     │ │
│  │     비밀번호: [________________________]                            │ │
│  │                                                                     │ │
│  │     비밀번호 확인: [________________________]                       │ │
│  │                                                                     │ │
│  │     [        회원가입        ]                                      │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 2. 회원가입 요청
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        Supabase Auth                                      │
│                                                                           │
│  const { error } = await supabase.auth.signUp({                          │
│    email: email,                                                          │
│    password: password,                                                    │
│  });                                                                      │
│                                                                           │
│  - 이메일 중복 확인                                                       │
│  - 비밀번호 정책 확인 (최소 6자)                                         │
│  - 사용자 레코드 생성                                                     │
│  - profiles 테이블에 기본 프로필 생성 (트리거)                           │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 3. 프로필 설정 페이지로 이동
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                         /signup 페이지 (프로필 설정)                      │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                     │ │
│  │     닉네임: [________________________]                              │ │
│  │                                                                     │ │
│  │     학교: [________________________]                                │ │
│  │                                                                     │ │
│  │     전공: [________________________]                                │ │
│  │                                                                     │ │
│  │     복수전공: [________________________] (선택)                     │ │
│  │                                                                     │ │
│  │     [        저장        ]                                          │ │
│  │                                                                     │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 4. 프로필 저장
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      profiles 테이블 업데이트                             │
│                                                                           │
│  await supabase                                                           │
│    .from("profiles")                                                      │
│    .update({                                                              │
│      username: nickname,                                                  │
│      school_name: school,                                                 │
│      major: major,                                                        │
│      double_major: doubleMajor,                                           │
│    })                                                                     │
│    .eq("id", user.id);                                                    │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 5. 홈 페이지로 이동
        ▼
     홈 페이지 (/)
```

---

## 5. 로그아웃 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              로그아웃 흐름                                           │
└─────────────────────────────────────────────────────────────────────────────────────┘

     사용자
        │
        │ 1. 로그아웃 버튼 클릭
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      LogoutButton.tsx                                     │
│                                                                           │
│  const { logout } = useAuth();                                           │
│                                                                           │
│  const handleLogout = async () => {                                      │
│    await logout();                                                        │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 2. AuthContext의 logout 함수 실행
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      AuthContext.tsx                                      │
│                                                                           │
│  const logout = async () => {                                            │
│    await supabase.auth.signOut();                                        │
│    setUser(null);                                                         │
│    router.push("/login");                                                 │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 3. Supabase 세션 종료
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                        Supabase Auth                                      │
│                                                                           │
│  - 세션 토큰 무효화                                                       │
│  - 쿠키 삭제                                                              │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │ 4. 로그인 페이지로 리다이렉트
        ▼
     로그인 페이지 (/login)
```

---

## 6. AuthGuard 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           AuthGuard 컴포넌트 흐름                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

     페이지 렌더링
        │
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      AuthGuard.tsx                                        │
│                                                                           │
│  useEffect(() => {                                                       │
│    const checkProfile = async () => {                                    │
│      const { data: { user } } = await supabase.auth.getUser();          │
│                                                                           │
│      if (user) {                                                         │
│        const { data: profile } = await supabase                          │
│          .from("profiles")                                                │
│          .select("major")                                                 │
│          .eq("id", user.id)                                              │
│          .single();                                                       │
│                                                                           │
│        if (profile?.major === "전공 미입력") {                           │
│          router.push("/signup");  // 프로필 미완성                       │
│        }                                                                  │
│      }                                                                    │
│    };                                                                     │
│                                                                           │
│    checkProfile();                                                        │
│  }, []);                                                                  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        ├── 프로필 완성 → 현재 페이지 표시
        │
        └── 프로필 미완성 → /signup 페이지로 리다이렉트
```

---

## 7. 미들웨어 세션 갱신

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           미들웨어 세션 갱신                                         │
└─────────────────────────────────────────────────────────────────────────────────────┘

     모든 요청
        │
        │
        ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                      middleware.ts                                        │
│                                                                           │
│  export async function middleware(request: NextRequest) {                │
│    const response = NextResponse.next();                                 │
│                                                                           │
│    const supabase = createMiddlewareClient({                             │
│      req: request,                                                        │
│      res: response                                                        │
│    });                                                                     │
│                                                                           │
│    // 세션 자동 갱신                                                      │
│    await supabase.auth.getSession();                                     │
│                                                                           │
│    return response;                                                       │
│  }                                                                        │
│                                                                           │
│  export const config = {                                                 │
│    matcher: ['/((?!_next/static|_next/image|favicon.ico).*)'],           │
│  };                                                                       │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
        │
        │
        ▼
     요청 처리 계속
```

---

## 8. 관련 파일

| 파일 | 역할 |
|------|------|
| `src/app/login/page.tsx` | 로그인 페이지 |
| `src/app/join/page.tsx` | 회원가입 페이지 |
| `src/app/signup/page.tsx` | 프로필 설정 페이지 |
| `src/app/auth/callback/route.ts` | OAuth 콜백 핸들러 |
| `src/contexts/AuthContext.tsx` | 인증 상태 관리 |
| `src/component/AuthGuard.tsx` | 인증 보호 컴포넌트 |
| `src/component/SocialLoginSection.tsx` | 소셜 로그인 버튼 |
| `src/middleware.ts` | 세션 갱신 미들웨어 |
